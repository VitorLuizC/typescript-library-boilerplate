#!/bin/bash

set -o errexit

if [ -d "./node_modules/.bin" ]; then
  export PATH="./node_modules/.bin:$PATH"
fi

function setup() {
  echo -e "ğŸ”„ updating asdfâ€¦\n"
  asdf update

  echo -e ""
  echo -e "ğŸ”„ updating asdf's pluginsâ€¦\n"
  asdf plugin update nodejs

  echo -e ""
  echo -e "â¬‡ï¸ installing asdf's packagesâ€¦\n"
  asdf install

  echo -e ""
  echo -e "ğŸ”„ updating npmâ€¦\n"
  npm up npm --global

  echo -e ""
  echo -e "â¬‡ï¸ installing packages with npmâ€¦\n"
  npm ci
}

function cleanup() {
  echo -e "ğŸ—‘ï¸ deleting './node_modules' folderâ€¦\n"
  rm -rf ./node_modules

  echo -e ""
  echo -e "ğŸ—‘ï¸ deleting './package-lock.json' fileâ€¦\n"
  rm ./package-lock.json

  echo -e ""
  echo -e "â¬‡ï¸ installing packages with npmâ€¦\n"
  npm install
}

function doc() {
  echo -e "ğŸ¤– generating documentation with Typedocâ€¦\n"
  typedoc "./src/index.ts"
}

function test() {
  echo -e "ğŸ§ª executing unit tests with Jestâ€¦\n"
  jest
}

function type-check() {
  echo -e "ğŸ” type checking with TypeScriptâ€¦\n"
  tsc --project ./tsconfig.json --noEmit
}

function check() {
  echo -e "ğŸ” checking code style with ESLintâ€¦\n"
  eslint

  echo -e "â–¶ executing 'type-check' commandâ€¦\n"
  echo ""
  bash run type-check
}

function autofix() {
  echo -e "ğŸ‘¨â€ğŸ”§ automatically fixing source code with ESLintâ€¦\n"
  eslint "*/**/*.{ts,js,json}" --fix
}

function bundle() {
  echo -e "ğŸ“¦ bundling source code with Rollupâ€¦\n"
  rollup --config ./rollup.config.mjs
}

function prepublish-only() {
  echo -e "â–¶ executing 'doc' commandâ€¦\n"
  bash run doc

  echo ""
  echo -e "â–¶ executing 'check' commandâ€¦\n"
  bash run check

  echo ""
  echo -e "â–¶ executing 'test' commandâ€¦\n"
  bash run test

  echo ""
  echo -e "â–¶ executing 'bundle' commandâ€¦\n"
  bash run bundle
}

eval "$@"
