#!/bin/bash

set -o errexit

if [ -d "./node_modules/.bin" ]; then
  export PATH="./node_modules/.bin:$PATH"
fi

function setup() {
  echo -e "ğŸ”„ updating asdfâ€¦\n"
  asdf update

  echo -e ""
  echo -e "ğŸ”„ updating asdf's pluginsâ€¦\n"
  asdf plugin update nodejs

  echo -e ""
  echo -e "â¬‡ï¸ installing asdf's packagesâ€¦\n"
  asdf install

  echo -e ""
  echo -e "ğŸ”„ updating npmâ€¦\n"
  npm up npm --global

  echo -e ""
  echo -e "â¬‡ï¸ installing packages with npmâ€¦\n"
  npm ci
}

function cleanup() {
  echo -e "ğŸ—‘ï¸ deleting './node_modules' folderâ€¦\n"
  rm -rf ./node_modules

  echo -e ""
  echo -e "ğŸ—‘ï¸ deleting './package-lock.json' fileâ€¦\n"
  rm ./package-lock.json

  echo -e ""
  echo -e "â¬‡ï¸ installing packages with npmâ€¦\n"
  npm install
}

function execute() {
  echo -e "â–¶ executing '$1' scriptâ€¦\n"
  bash run $1 | sed 's/^/  /'
  echo -e "\nâœ… '$1' script was completed!"
}

function doc() {
  echo -e "ğŸ¤– generating documentation with Typedocâ€¦\n"
  typedoc "./src/index.ts"
}

function test() {
  echo -e "ğŸ§ª executing unit tests with Jestâ€¦\n"
  jest
}

function type-check() {
  echo -e "ğŸ” type checking with TypeScriptâ€¦\n"
  tsc --project ./tsconfig.json --noEmit
}

function lint() {
  echo -e "ğŸ” linting code style with ESLint and Prettierâ€¦\n"
  eslint
}

function check() {
  execute lint
  echo ""
  execute type-check
}

function autofix() {
  echo -e "ğŸ‘¨â€ğŸ”§ automatically fixing source code with ESLintâ€¦\n"
  eslint "*/**/*.{ts,js,json}" --fix
}

function bundle() {
  echo -e "ğŸ“¦ bundling source code with Rollupâ€¦\n"
  rollup --config ./rollup.config.mjs
}

function prepublish-only() {
  execute doc
  echo ""
  execute check
  echo ""
  execute test
  echo ""
  execute bundle
}

eval "$@"
